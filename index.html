<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aquarelle 3D Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/excel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
       :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #48bb78;
            --danger-color: #f56565;
            --warning-color: #ed8936;
            --bg-color: #f7fafc;
            --card-bg-color: #ffffff;
            --text-color: #2d3748;
            --subtext-color: #718096;
            --border-color: #e2e8f0;
            --sidebar-width: 260px;
            --header-height: 70px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 1000;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
        }

        .sidebar-header {
            padding: 0 20px;
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .company-logo {
            width: 60px;
            height: auto;
        }

        .sidebar-header h2 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .nav-links {
            list-style: none;
            flex-grow: 1;
            overflow-y: auto;
        }

        .nav-links li a {
            color: #e2e8f0;
            text-decoration: none;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-links li a .fas {
            margin-right: 15px;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .nav-links li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-links li a.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border-left-color: var(--accent-color);
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            background-color: var(--card-bg-color);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 999;
            height: var(--header-height);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }

        .company-info {
            display: flex;
            align-items: center;
        }
        
        .header-logo {
            height: 40px;
            margin-right: 15px;
        }

        .company-info h1 {
            font-size: 1.4rem;
            color: var(--text-color);
            margin: 0;
            font-weight: 600;
        }

        .time-display {
            font-size: 0.85rem;
            color: var(--subtext-color);
            margin-top: 3px;
        }
        
        .notification-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.3rem;
            color: var(--subtext-color);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .notification-bell:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            width: 320px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            z-index: 1001;
            max-height: 400px;
            overflow-y: auto;
        }

        .dropdown-header {
            padding: 12px 15px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            background-color: #f8fafc;
            position: sticky;
            top: 0;
        }
        
        .dropdown-content {
            max-height: 350px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .notification-item:hover {
            background-color: var(--bg-color);
        }

        .notification-item:last-child {
            border-bottom: none;
        }
        
        .notification-title { 
            font-weight: 600; 
            font-size: 0.95rem;
            margin-bottom: 3px;
            color: var(--text-color);
        }
        .notification-body { 
            font-size: 0.85rem; 
            color: var(--subtext-color); 
            margin-bottom: 5px; 
            line-height: 1.4;
        }
        .notification-meta { 
            font-size: 0.75rem; 
            color: var(--subtext-color); 
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Page Content */
        .page {
            display: none;
            padding: 25px;
            animation: fadeIn 0.5s ease-in-out;
            flex-grow: 1;
        }

        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .page-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .page-actions .btn {
            margin-left: 0;
        }

        /* Card */
        .card {
            background-color: var(--card-bg-color);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .card h3 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-color);
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Dashboard */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 150px;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.2);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 5px;
        }

        .investment-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--subtext-color);
            font-size: 0.9rem;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background-color: #fff;
            transition: border-color 0.2s;
        }

        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input:read-only {
            background-color: #f8fafc;
            cursor: not-allowed;
        }

        .quantity-section, .image-section, .project-history-section, .management-grid {
            margin-top: 30px;
        }
        
        .quantity-section h3, .image-section h3, .project-history-section h3 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .quantity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .total-qty, .total-savings {
            font-weight: bold;
            grid-column: span 1;
        }
        
        .total-qty input, .total-savings input {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .image-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .image-preview {
            width: 100%;
            min-height: 200px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: #fdfdfd;
        }
        
        .image-preview .empty-state {
            color: var(--subtext-color);
            font-size: 0.9rem;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            cursor: pointer;
        }

        .form-actions {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .btn-primary { 
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); 
            color: white; 
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:hover { 
            background: linear-gradient(to right, #5a6fcb, #6a3fa0); 
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary { 
            background-color: #e2e8f0; 
            color: var(--text-color); 
        }
        .btn-secondary:hover { 
            background-color: #cbd5e0; 
            transform: translateY(-2px);
        }
        
        .btn-danger { 
            background: linear-gradient(to right, var(--danger-color), #e53e3e); 
            color: white; 
            box-shadow: 0 4px 10px rgba(245, 101, 101, 0.2);
        }
        .btn-danger:hover { 
            background: linear-gradient(to right, #e53e3e, #c53030); 
            transform: translateY(-2px);
        }

        .btn-success { 
            background: linear-gradient(to right, var(--accent-color), #38a169); 
            color: white; 
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.3);
        }
        .btn-success:hover { 
            background: linear-gradient(to right, #38a169, #2f855a); 
            transform: translateY(-2px);
        }

        .btn-warning { 
            background: linear-gradient(to right, var(--warning-color), #dd6b20); 
            color: white; 
        }
        .btn-warning:hover { 
            background: linear-gradient(to right, #dd6b20, #c05621); 
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* History Tables */
        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-container {
            display: flex;
            flex-grow: 1;
            min-width: 250px;
        }
        
        .search-container input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-right: none;
            border-radius: 8px 0 0 8px;
            font-size: 0.95rem;
        }
        
        .search-container button {
            border-radius: 0 8px 8px 0;
            padding: 0 20px;
        }
        
        .location-filter {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .location-filter select {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .table-container {
            overflow-x: auto;
            background-color: var(--card-bg-color);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .data-table th, .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95rem;
        }

        .data-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: var(--text-color);
            position: sticky;
            top: 0;
        }

        .data-table tbody tr {
            transition: background-color 0.2s;
        }

        .data-table tbody tr:hover {
            background-color: #f7fafc;
        }

        .data-table .image-thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        /* Feedback Page */
        .star-rating {
            display: flex;
            gap: 5px;
            font-size: 1.8rem;
            color: #e2e8f0;
        }
        
        .star-rating .star {
            cursor: pointer;
            transition: color 0.2s;
        }

        .star-rating .star.active, .star-rating .star:hover {
            color: #ffd700;
        }
        
        /* Needed Projects Page */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            text-transform: capitalize;
            display: inline-block;
        }
        
        .status-badge.status-low { background-color: #4299e1; }
        .status-badge.status-medium { background-color: #ed8936; }
        .status-badge.status-high { background-color: #f56565; }
        .status-badge.status-pending { background-color: #a0aec0; }
        .status-badge.status-completed { background-color: #48bb78; }
        
        .completed-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 25px;
            padding: 20px;
            background-color: #edf2f7;
            border-radius: 10px;
            flex-wrap: wrap;
        }
        
        .completed-section input {
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            flex-grow: 1;
            min-width: 200px;
        }

        /* Unit/Filament Page */
        .management-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }
        
        .printer-list, .filament-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .printer-item, .filament-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #fff;
        }

        .printer-info, .filament-info {
            flex-grow: 1;
        }
        
        .printer-name, .filament-type {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .printer-model, .filament-color {
            font-size: 0.9rem;
            color: var(--subtext-color);
        }
        
        .printer-status {
            font-size: 0.85rem;
            padding: 3px 10px;
            border-radius: 20px;
            background-color: #e6f7ee;
            color: #48bb78;
        }
        
        .printer-status.maintenance {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        .printer-status.offline {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        /* Camera */
        .camera-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        #camera-video {
            max-width: 90%;
            max-height: 70%;
            border-radius: 10px;
            background-color: #000;
        }

        .camera-controls {
            margin-top: 20px;
            display: flex;
            gap: 20px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            display: none;
        }
        
        .modal.active { 
            display: flex; 
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            position: relative;
            animation: slideIn 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content.image-modal {
            background: none;
            padding: 0;
            max-width: 90vw;
            max-height: 90vh;
            width: auto;
        }
        
        #modal-image {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .close-modal {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
        }
        
        .modal-content.image-modal .close-modal {
            color: white;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            top: 15px;
            right: 15px;
        }
        
        #auth-password {
            width: 100%;
            padding: 12px 15px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        #record-detail-content .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .detail-grid div {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-grid div:last-child {
            border-bottom: none;
        }

        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Alert Container */
        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateX(100%);
            animation: slideInAlert 0.5s forwards;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        
        .alert-success { background-color: var(--accent-color); }
        .alert-error { background-color: var(--danger-color); }
        .alert-info { background-color: var(--primary-color); }
        .alert-warning { background-color: var(--warning-color); }
        
        .alert i {
            font-size: 1.2rem;
        }
        
        @keyframes slideInAlert {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .management-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .mobile-menu-btn {
                display: block;
            }
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            .header {
                padding: 0 20px;
            }
            .company-info h1 {
                font-size: 1.2rem;
            }
            .page {
                padding: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            .form-grid, .quantity-grid, .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .completed-section {
                flex-direction: column;
                align-items: stretch;
            }
            .completed-section button {
                width: 100%;
            }
            .notification-dropdown {
                width: 280px;
                right: 10px;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
        
        @media (max-width: 576px) {
            .header {
                flex-wrap: wrap;
                height: auto;
                padding: 15px;
            }
            .header-left {
                width: 100%;
                justify-content: space-between;
                margin-bottom: 10px;
            }
            .notification-area {
                width: 100%;
                justify-content: flex-end;
            }
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .page-actions {
                width: 100%;
                justify-content: flex-start;
            }
            .form-actions {
                flex-direction: column;
            }
            .form-actions .btn {
                width: 100%;
            }
            .btn {
                padding: 12px 15px;
            }
        }
    </style>
</head>
<body>

 <div class="app-container">
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <img src="logo.png" alt="Aquarelle Logo" class="company-logo">
            </div>
            <h2><i class="fas fa-cube"></i> 3D Analytics</h2>
        </div>
        <ul class="nav-links">
            <li><a href="#dashboard" class="nav-link active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
            <li><a href="#add-record" class="nav-link"><i class="fas fa-plus-circle"></i> Add Record</a></li>
            <li><a href="#record-history" class="nav-link"><i class="fas fa-history"></i> Record History</a></li>
            <li><a href="#feedback" class="nav-link"><i class="fas fa-comment"></i> Feedback</a></li>
            <li><a href="#feedback-history" class="nav-link"><i class="fas fa-comments"></i> Feedback History</a></li>
            <li><a href="#needed-projects" class="nav-link"><i class="fas fa-project-diagram"></i> Needed Projects</a></li>
            <li><a href="#unit-filament" class="nav-link"><i class="fas fa-cogs"></i> Unit/Filament</a></li>
        </ul>
    </nav>
    <main class="main-content">
        <header class="header">
            <div class="header-left">
                <button class="mobile-menu-btn" onclick="app.toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="company-info">
                    <img src="logo1.png" alt="Aquarelle Logo" class="header-logo">
                    <div>
                        <h1>Aquarelle India Pvt. Ltd</h1>
                        <div class="time-display" id="current-time"></div>
                    </div>
                </div>
            </div>
            <div class="notification-area">
                <div class="notification-bell" id="feedback-bell" onclick="app.toggleNotifications('feedback')">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="feedback-count">0</span>
                    <div class="notification-dropdown" id="feedback-dropdown">
                        <div class="dropdown-header">Feedback Notifications</div>
                        <div class="dropdown-content" id="feedback-notifications"></div>
                    </div>
                </div>
                <div class="notification-bell" id="projects-bell" onclick="app.toggleNotifications('projects')">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="project-count">0</span>
                    <div class="notification-dropdown" id="project-dropdown">
                        <div class="dropdown-header">Project Notifications</div>
                        <div class="dropdown-content" id="project-notifications"></div>
                    </div>
                </div>
            </div>
        </header>
        <div id="dashboard" class="page active">
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="card-header">ROI</div>
                    <div class="card-value" id="roi-value">₹600000.00</div>
                </div>
                <div class="summary-card">
                    <div class="card-header">Savings</div>
                    <div class="card-value" id="savings-value">₹0.00</div>
                </div>
                <div class="summary-card">
                    <div class="card-header">Time</div>
                    <div class="card-value" id="time-value">0.00 hrs</div>
                </div>
                <div class="summary-card">
                    <div class="card-header">Records</div>
                    <div class="card-value" id="records-value">0</div>
                </div>
            </div>
            <div class="card">
                <h3>Investment Settings</h3>
                <div class="investment-section">
                    <label for="investment-amount">Total Investment (₹):</label>
                    <input type="number" id="investment-amount" placeholder="600000">
                    <button id="update-investment" class="btn btn-primary" onclick="app.requestAuth('updateInvestment')">Update Investment</button>
                </div>
            </div>
            <div class="dashboard-grid">
                <div class="card">
                    <h3>ROI Analytics</h3>
                    <canvas id="roi-chart"></canvas>
                </div>
                
                <div class="card">
                    <h3>Total Savings vs Investment</h3>
                    <canvas id="savings-chart"></canvas>
                </div>
                
                <div class="card">
                    <h3>Material Usage</h3>
                    <canvas id="material-chart"></canvas>
                </div>
                
                <div class="card">
                    <h3>Records Over Time</h3>
                    <canvas id="records-chart"></canvas>
                </div>
                
                <div class="card">
                    <h3>Printing Hours</h3>
                    <canvas id="hours-chart"></canvas>
                </div>
            </div>
        </div>
        <div id="add-record" class="page">
            <div class="page-header">
                <h2>Add New Record</h2>
            </div>

            <form id="record-form" class="record-form card">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="date">Date:</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-name">Project Name:</label>
                        <input type="text" id="project-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="part-type">Type:</label>
                        <input type="text" id="part-type" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="part-size">Size:</label>
                        <input type="text" id="part-size" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="part-name">Part Name:</label>
                        <input type="text" id="part-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="application">Application:</label>
                        <input type="text" id="application" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="sharepoint-link">SharePoint Link:</label>
                        <input type="url" id="sharepoint-link">
                    </div>
                    
                    <div class="form-group">
                        <label for="material-used">Material Used:</label>
                        <select id="material-used" name="material-used" required>
                            <option value="">Select Material</option>
                            <option value="pla-plus">PLA+</option>
                            <option value="silk-pla">Silk PLA</option>
                            <option value="abs">ABS</option>
                            <option value="petg">PETG</option>
                            <option value="tpu">TPU</option>
                            <option value="pla">PLA</option>
                            <option value="nylon">Nylon</option>
                            <option value="polycarbonate">PC (Polycarbonate)</option>
                            <option value="asa">ASA</option>
                            <option value="hips">HIPS</option>
                            <option value="carbon-fiber-pla">Carbon Fiber PLA</option>
                            <option value="carbon-fiber-nylon">Carbon Fiber Nylon</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="machine-name">Machine Name:</label>
                        <select id="machine-name" name="machine-name" required>
                            <option value="">Select Machine</option>
                            <option value="bambu-lab-p1s">Bambu Lab P1S</option>
                            <option value="creality-ender-3-v3-ke">Creality Ender 3 V3 KE</option>
                            <option value="creality-ender-5-s1">Creality Ender 5 S1</option>
                            <option value="creality-k1-max">Creality K1 Max</option>
                            <option value="prusa-i3-mk4">Prusa i3 MK4</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="printing-time-mins">Printing Time (minutes):</label>
                        <input type="number" id="printing-time-mins" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="printing-time-hrs">Printing Time (hours):</label>
                        <input type="number" id="printing-time-hrs" step="0.01" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="print-price">Material Cost (₹):</label>
                        <input type="number" id="print-price" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="electricity-cost">Electricity Cost (₹):</label>
                        <input type="number" id="electricity-cost" step="0.01" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="3d-print-cost">3D Print Cost (₹):</label>
                        <input type="number" id="3d-print-cost" step="0.01" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="oem-cost">OEM Cost (₹):</label>
                        <input type="number" id="oem-cost" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="savings-per-product">Savings per Product (₹):</label>
                        <input type="number" id="savings-per-product" step="0.01" readonly>
                    </div>
                </div>
                
                <div class="quantity-section">
                    <h3>Quantity Distribution</h3>
                    <div class="quantity-grid">
                        <div class="form-group">
                            <label for="bng-qty">BNG:</label>
                            <input type="number" id="bng-qty" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="sampling-qty">Sampling:</label>
                            <input type="number" id="sampling-qty" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="rcc-qty">RCC:</label>
                            <input type="number" id="rcc-qty" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="rd-qty">R&D:</label>
                            <input type="number" id="rd-qty" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="kaa-qty">Andhara:</label>
                            <input type="number" id="kaa-qty" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="bom-qty">HO:</label>
                            <input type="number" id="bom-qty" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="other-qty">Other Unit:</label>
                            <input type="number" id="other-qty" min="0" value="0">
                        </div>
                        <div class="total-qty">
                            <label for="total-quantity">Total Quantity:</label>
                            <input type="number" id="total-quantity" readonly>
                        </div>
                        <div class="total-savings">
                            <label for="total-savings">Total Savings (₹):</label>
                            <input type="number" id="total-savings" readonly>
                        </div>
                    </div>
                </div>
                
                <div class="image-section">
                    <h3>Product Image</h3>
                    <div class="image-controls">
                        <input type="file" id="image-upload" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('image-upload').click()">
                            <i class="fas fa-upload"></i> Upload Image
                        </button>
                        <button type="button" class="btn btn-primary" onclick="app.startCamera()">
                            <i class="fas fa-camera"></i> Take Photo
                        </button>
                        <button type="button" class="btn btn-danger" onclick="app.removeImage()">
                            <i class="fas fa-trash"></i> Remove Image
                        </button>
                    </div>
                    <div class="image-preview" id="image-preview">
                        <div class="empty-state">No image selected</div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Record
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="app.resetForm()">
                        <i class="fas fa-undo"></i> Reset Form
                    </button>
                </div>
            </form>
        </div>
        <div id="record-history" class="page">
            <div class="page-header">
                <h2>Record History</h2>
                <div class="page-actions">
                    <button class="btn btn-danger" onclick="app.requestAuth('clearAllRecords')">
                        <i class="fas fa-trash-alt"></i> Clear All Records
                    </button>
<button id="export-excel-btn" class="btn btn-primary">
    <i class="fas fa-file-excel"></i> Export to Excel
</button>
                </div>
            </div>

            <div class="filter-section">
                <div class="search-container">
                    <input type="text" id="record-search" placeholder="Search records by project, part name, material..." onkeyup="app.searchRecords()">
                    <button class="btn btn-secondary" onclick="app.clearSearch('record')">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table" id="records-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Project</th>
                            <th>Part Name</th>
                            <th>Material</th>
                            <th>Quantity</th>
                            <th>Savings</th>
                            <th>Image</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody">
                    </tbody>
                </table>
            </div>
        </div>
        <div id="feedback" class="page">
            <div class="page-header">
                <h2>Submit Feedback</h2>
            </div>

            <form id="feedback-form" class="feedback-form card">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="feedback-name">Name:</label>
                        <input type="text" id="feedback-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="feedback-email">Email:</label>
                        <input type="email" id="feedback-email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="feedback-location">Location:</label>
                        <select id="feedback-location" required>
                            <option value="">Select Location</option>
                            <option value="BNG">BNG</option>
                            <option value="Sampling">Sampling</option>
                            <option value="RCC">RCC</option>
                            <option value="R&D">R&D</option>
                            <option value="Andhara">Andhara</option>
                            <option value="HO">HO</option>
                            <option value="other">Other Units</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="feedback-category">Category:</label>
                        <select id="feedback-category" required>
                            <option value="">Select Category</option>
                            <option value="feature-request">Feature Request</option>
                            <option value="bug-report">Bug Report</option>
                            <option value="general-feedback">General Feedback</option>
                            <option value="improvement-suggestion">Improvement Suggestion</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="feedback-subject">Subject:</label>
                    <input type="text" id="feedback-subject" required>
                </div>
                
                <div class="form-group">
                    <label for="feedback-message">Message:</label>
                    <textarea id="feedback-message" rows="5" required placeholder="Please provide your feedback..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Rating:</label>
                    <div class="star-rating" id="star-rating">
                        <i class="fas fa-star star" data-rating="1"></i>
                        <i class="fas fa-star star" data-rating="2"></i>
                        <i class="fas fa-star star" data-rating="3"></i>
                        <i class="fas fa-star star" data-rating="4"></i>
                        <i class="fas fa-star star" data-rating="5"></i>
                    </div>
                    <input type="hidden" id="feedback-rating" value="0">
                </div>
                
                <div class="image-section">
                    <h3>Attachment (Optional)</h3>
                    <div class="image-controls">
                        <input type="file" id="feedback-image-upload" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('feedback-image-upload').click()">
                            <i class="fas fa-upload"></i> Upload Image
                        </button>
                        <button type="button" class="btn btn-primary" onclick="app.startFeedbackCamera()">
                            <i class="fas fa-camera"></i> Take Photo
                        </button>
                        <button type="button" class="btn btn-danger" onclick="app.removeFeedbackImage()">
                            <i class="fas fa-trash"></i> Remove Image
                        </button>
                    </div>
                    <div class="image-preview" id="feedback-image-preview">
                        <div class="empty-state">No image selected</div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Submit Feedback
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="app.resetFeedbackForm()">
                        <i class="fas fa-undo"></i> Reset Form
                    </button>
                </div>
            </form>
        </div>
        <div id="feedback-history" class="page">
            <div class="page-header">
                <h2>Feedback History</h2>
                <div class="page-actions">
                    <button class="btn btn-danger" onclick="app.requestAuth('clearAllFeedback')">
                        <i class="fas fa-trash-alt"></i> Clear All Feedback
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table class="data-table" id="feedback-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Subject</th>
                            <th>Category</th>
                            <th>Rating</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="feedback-tbody">
                    </tbody>
                </table>
            </div>
        </div>
        <div id="needed-projects" class="page">
            <div class="page-header">
                <h2>Needed Projects</h2>
            </div>

            <form id="project-form" class="project-form card">
                <h3>Add New Project</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="project-unique-id">Unique ID:</label>
                        <input type="text" id="project-unique-id" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-title">Project Title:</label>
                        <input type="text" id="project-title" required>
                    </div>
                    
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="project-description">Description:</label>
                        <textarea id="project-description" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-priority">Priority:</label>
                        <select id="project-priority" required>
                            <option value="">Select Priority</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-location">Location:</label>
                        <select id="project-location" required>
                            <option value="">Select Location</option>
                            <option value="BNG">BNG</option>
                            <option value="Sampling">Sampling</option>
                            <option value="RCC">RCC</option>
                            <option value="R&D">R&D</option>
                            <option value="Andhara">Andhara</option>
                            <option value="HO">HO</option>
                            <option value="other">Other Units</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-due-date">Due Date:</label>
                        <input type="date" id="project-due-date" required>
                    </div>
                </div>
                
                <div class="image-section">
                    <h3>Project Image (Optional)</h3>
                    <div class="image-controls">
                        <input type="file" id="project-image-upload" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('project-image-upload').click()">
                            <i class="fas fa-upload"></i> Upload Image
                        </button>
                        <button type="button" class="btn btn-primary" onclick="app.startProjectCamera()">
                            <i class="fas fa-camera"></i> Take Photo
                        </button>
                        <button type="button" class="btn btn-danger" onclick="app.removeProjectImage()">
                            <i class="fas fa-trash"></i> Remove Image
                        </button>
                    </div>
                    <div class="image-preview" id="project-image-preview">
                        <div class="empty-state">No image selected</div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Project
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="app.resetProjectForm()">
                        <i class="fas fa-undo"></i> Reset Form
                    </button>
                </div>
            </form>

            <div class="project-history-section card">
                <h3>Project History</h3>
                
                <div class="completed-section">
                    <label for="completed-project-id">Mark as Completed - Enter Unique ID:</label>
                    <input type="text" id="completed-project-id" placeholder="Enter 5-digit project ID">
                    <button class="btn btn-success" onclick="app.requestAuth('markProjectCompleted')">
                        <i class="fas fa-check"></i> Mark Completed
                    </button>
                </div>

                <div class="table-container" style="margin-top: 20px;">
                    <table class="data-table" id="projects-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Priority</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projects-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="unit-filament" class="page">
            <div class="page-header">
                <h2>Unit/Filament Management</h2>
            </div>

            <div class="management-grid">
                <div class="card">
                    <h3>Add New Printer</h3>
                    <form id="printer-form">
                        <div class="form-group">
                            <label for="printer-name">Printer Name:</label>
                            <input type="text" id="printer-name" required>
                        </div>
                        <div class="form-group">
                            <label for="printer-model">Model:</label>
                            <input type="text" id="printer-model" required>
                        </div>
                        <div class="form-group">
                            <label for="printer-status">Status:</label>
                            <select id="printer-status" required>
                                <option value="active">Active</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="offline">Offline</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Printer</button>
                    </form>
                    
                    <div class="printer-list">
                        <h4>Current Printers</h4>
                        <div id="printer-items">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Add New Filament</h3>
                    <form id="filament-form">
                        <div class="form-group">
                            <label for="filament-type">Filament Type:</label>
                            <input type="text" id="filament-type" required>
                        </div>
                        <div class="form-group">
                            <label for="filament-color">Color:</label>
                            <input type="text" id="filament-color" required>
                        </div>
                        <div class="form-group">
                            <label for="filament-weight">Weight (kg):</label>
                            <input type="number" id="filament-weight" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="filament-cost">Cost per kg (₹):</label>
                            <input type="number" id="filament-cost" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Filament</button>
                    </form>
                    
                    <div class="filament-list">
                        <h4>Current Filaments</h4>
                        <div id="filament-items">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<div id="camera-container" class="camera-container" style="display: none;">
    <video id="camera-video" autoplay playsinline></video>
    <canvas id="camera-canvas" style="display: none;"></canvas>
    <div class="camera-controls">
        <button class="btn btn-primary" onclick="app.capturePhoto()">
            <i class="fas fa-camera"></i> Capture
        </button>
        <button class="btn btn-secondary" onclick="app.stopCamera()">
            <i class="fas fa-times"></i> Cancel
        </button>
    </div>
</div>
<div id="auth-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="app.closeModal('auth-modal')">×</span>
        <h3>Authentication Required</h3>
        <p id="auth-message">Please enter the authentication password:</p>
        <input type="password" id="auth-password" placeholder="Enter password">
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="app.verifyAuth()">Verify</button>
            <button class="btn btn-secondary" onclick="app.closeModal('auth-modal')">Cancel</button>
        </div>
    </div>
</div>

<div id="image-modal" class="modal">
    <div class="modal-content image-modal">
        <span class="close-modal" onclick="app.closeModal('image-modal')">×</span>
        <img id="modal-image" src="" alt="Full size image">
    </div>
</div>

<div id="record-detail-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="app.closeModal('record-detail-modal')">×</span>
        <h3 id="record-detail-title">Details</h3>
        <div id="record-detail-content"></div>
    </div>
</div>
<div id="alert-container"></div>
<script>
class PrintingAnalyticsApp {
    constructor() {
        this.records = JSON.parse(localStorage.getItem('printingRecords')) || [];
        this.feedback = JSON.parse(localStorage.getItem('feedbackData')) || [];
        this.projects = JSON.parse(localStorage.getItem('projectsData')) || [];
        this.printers = JSON.parse(localStorage.getItem('printersData')) || [];
        this.filaments = JSON.parse(localStorage.getItem('filamentsData')) || [];
        this.investment = parseFloat(localStorage.getItem('totalInvestment')) || 600000;
        this.readFeedback = JSON.parse(localStorage.getItem('readFeedback')) || [];
        this.readProjects = JSON.parse(localStorage.getItem('readProjects')) || [];
        
        this.currentRecordImage = null;
        this.currentFeedbackImage = null;
        this.currentProjectImage = null;
        
        this.currentStream = null;
        this.cameraType = 'record';
        
        this.currentPage = 'dashboard';
        this.authAction = null;
        this.authId = null;
        this.authPassword = '3dprinter@aqrl';
        
        this.projectIdCounter = parseInt(localStorage.getItem('projectIdCounter')) || 1;
        this.editingRecordId = null;

        this.roiChart = null;
        this.savingsChart = null;
        this.materialChart = null;
        this.recordsChart = null;
        this.hoursChart = null;
        
        this.init();
    }
    init() {
        this.updateTime();
        this.setupEventListeners();
        this.loadStoredPage();
        this.updateDashboard();
        this.updateNotificationsUI();
        this.populateManagementData();
        this.displayRecords();
        this.displayFeedback();
        this.displayProjects();
        
        setInterval(() => this.updateTime(), 1000);
        this.generateProjectId();
        
        window.onbeforeunload = () => this.saveAllData();
    }

    updateTime() {
        const now = new Date();
        const timeString = now.toLocaleString('en-IN', {
            timeZone: 'Asia/Kolkata',
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const timeElement = document.getElementById('current-time');
        if (timeElement) timeElement.textContent = timeString;
    }

    setupEventListeners() {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.getAttribute('href').substring(1);
                this.showPage(page);
            });
        });

        document.getElementById('record-form').addEventListener('submit', (e) => { e.preventDefault(); this.saveRecord(); });
        document.getElementById('feedback-form').addEventListener('submit', (e) => { e.preventDefault(); this.saveFeedback(); });
        document.getElementById('project-form').addEventListener('submit', (e) => { e.preventDefault(); this.saveProject(); });
        const exportBtn = document.getElementById('export-excel-btn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => this.exportToExcel());
        } else {
            console.error("Export to Excel button with id 'export-excel-btn' not found.");
        }

        document.getElementById('image-upload').addEventListener('change', (e) => this.handleImageUpload(e, 'record'));
        document.getElementById('feedback-image-upload').addEventListener('change', (e) => this.handleImageUpload(e, 'feedback'));
        document.getElementById('project-image-upload').addEventListener('change', (e) => this.handleImageUpload(e, 'project'));

        ['bng-qty', 'sampling-qty', 'rcc-qty', 'rd-qty', 'kaa-qty', 'bom-qty', 'other-qty'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => this.calculateTotals());
        });

        document.getElementById('printing-time-mins').addEventListener('input', () => this.calculateTimeAndCosts());
        document.getElementById('print-price').addEventListener('input', () => this.calculateCosts());
        document.getElementById('oem-cost').addEventListener('input', () => this.calculateCosts());

        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', (e) => this.setRating(e));
            star.addEventListener('mouseover', (e) => this.hoverRating(e));
        });
        document.getElementById('star-rating').addEventListener('mouseleave', () => this.resetHover());
        
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.closeModal(e.target.id);
            }
        });

        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('project-due-date').valueAsDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
    }
        saveAllData() {
    try {
        localStorage.setItem('printingRecords', JSON.stringify(this.records));
        localStorage.setItem('feedbackData', JSON.stringify(this.feedback));
        localStorage.setItem('projectsData', JSON.stringify(this.projects));
        localStorage.setItem('printersData', JSON.stringify(this.printers));
        localStorage.setItem('filamentsData', JSON.stringify(this.filaments));
        localStorage.setItem('totalInvestment', this.investment.toString());
        localStorage.setItem('projectIdCounter', this.projectIdCounter.toString());
        localStorage.setItem('readFeedback', JSON.stringify(this.readFeedback));
        localStorage.setItem('readProjects', JSON.stringify(this.readProjects));
    } catch (e) {
        console.error("Error saving data to localStorage:", e);
        this.showAlert("Could not save data. Storage might be full.", "error");
    }
}
    loadStoredPage() {
        const storedPage = localStorage.getItem('currentPage') || 'dashboard';
        this.showPage(storedPage, true);
    }
    showPage(pageId, isInitialLoad = false) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if(targetPage) {
            targetPage.classList.add('active');
        }

        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        const activeLink = document.querySelector(`.nav-link[href="#${pageId}"]`);
        if(activeLink) {
            activeLink.classList.add('active');
        }

        this.currentPage = pageId;
        localStorage.setItem('currentPage', pageId);
        
        if (!isInitialLoad) {
            switch(pageId) {
                case 'dashboard': this.updateDashboard(); break;
                case 'record-history': this.displayRecords(); break;
                case 'feedback-history': this.displayFeedback(); break;
                case 'needed-projects': this.displayProjects(); this.generateProjectId(); break;
            }
        }
    }
    calculateTotals() {
        const quantities = [
            'bng-qty', 'sampling-qty', 'rcc-qty', 'rd-qty', 'kaa-qty', 'bom-qty', 'other-qty'
        ].map(id => parseInt(document.getElementById(id).value) || 0);

        const totalQty = quantities.reduce((sum, qty) => sum + qty, 0);
        document.getElementById('total-quantity').value = totalQty;

        this.calculateCosts();
    }
    
    calculateTimeAndCosts() {
        const minutes = parseFloat(document.getElementById('printing-time-mins').value) || 0;
        const hours = minutes / 60;
        document.getElementById('printing-time-hrs').value = hours.toFixed(2);
        this.calculateCosts();
    }

    calculateCosts() {
        const printPrice = parseFloat(document.getElementById('print-price').value) || 0;
        const hours = parseFloat(document.getElementById('printing-time-hrs').value) || 0;
        
        const electricityCost = hours * 0.3 * 6;
        document.getElementById('electricity-cost').value = electricityCost.toFixed(2);
        
        const printCost = printPrice + electricityCost;
        document.getElementById('3d-print-cost').value = printCost.toFixed(2);
        
        const oemCost = parseFloat(document.getElementById('oem-cost').value) || 0;
        const savingsPerProduct = oemCost - printCost;
        document.getElementById('savings-per-product').value = savingsPerProduct.toFixed(2);
        
        const totalQty = parseInt(document.getElementById('total-quantity').value) || 0;
        const totalSavings = totalQty * savingsPerProduct;
        document.getElementById('total-savings').value = totalSavings.toFixed(2);
    }
    saveRecord() {
        const record = {
            id: this.editingRecordId || Date.now(),
            date: document.getElementById('date').value,
            projectName: document.getElementById('project-name').value,
            partType: document.getElementById('part-type').value,
            partSize: document.getElementById('part-size').value,
            partName: document.getElementById('part-name').value,
            application: document.getElementById('application').value,
            sharepointLink: document.getElementById('sharepoint-link').value,
            materialUsed: document.getElementById('material-used').value,
            machineName: document.getElementById('machine-name').value,
            printingTimeMins: parseFloat(document.getElementById('printing-time-mins').value),
            printingTimeHrs: parseFloat(document.getElementById('printing-time-hrs').value),
            printPrice: parseFloat(document.getElementById('print-price').value),
            electricityCost: parseFloat(document.getElementById('electricity-cost').value),
            printCost: parseFloat(document.getElementById('3d-print-cost').value),
            oemCost: parseFloat(document.getElementById('oem-cost').value),
            savingsPerProduct: parseFloat(document.getElementById('savings-per-product').value),
            quantities: {
                bng: parseInt(document.getElementById('bng-qty').value) || 0,
                sampling: parseInt(document.getElementById('sampling-qty').value) || 0,
                rcc: parseInt(document.getElementById('rcc-qty').value) || 0,
                rd: parseInt(document.getElementById('rd-qty').value) || 0,
                kaa: parseInt(document.getElementById('kaa-qty').value) || 0,
                bom: parseInt(document.getElementById('bom-qty').value) || 0,
                other: parseInt(document.getElementById('other-qty').value) || 0
            },
            totalQuantity: parseInt(document.getElementById('total-quantity').value),
            totalSavings: parseFloat(document.getElementById('total-savings').value),
            image: this.currentRecordImage,
            timestamp: new Date().toISOString()
        };
        
        if (this.editingRecordId) {
            const index = this.records.findIndex(r => r.id === this.editingRecordId);
            this.records[index] = record;
            this.showAlert('Record updated successfully!', 'success');
        } else {
            this.records.push(record);
            this.showAlert('Record saved successfully!', 'success');
        }
        
        this.saveAllData();
        this.updateDashboard();
        this.displayRecords();
        this.resetForm();
        this.editingRecordId = null;
    }
    editRecord(id) {
        const record = this.records.find(r => r.id === id);
        if (record) {
            this.editingRecordId = id;
            
            document.getElementById('date').value = record.date;
            document.getElementById('project-name').value = record.projectName;
            document.getElementById('part-type').value = record.partType;
            document.getElementById('part-size').value = record.partSize;
            document.getElementById('part-name').value = record.partName;
            document.getElementById('application').value = record.application;
            document.getElementById('sharepoint-link').value = record.sharepointLink;
            document.getElementById('material-used').value = record.materialUsed;
            document.getElementById('machine-name').value = record.machineName;
            document.getElementById('printing-time-mins').value = record.printingTimeMins;
            document.getElementById('print-price').value = record.printPrice;
            document.getElementById('oem-cost').value = record.oemCost;
            
            document.getElementById('bng-qty').value = record.quantities.bng || 0;
            document.getElementById('sampling-qty').value = record.quantities.sampling || 0;
            document.getElementById('rcc-qty').value = record.quantities.rcc || 0;
            document.getElementById('rd-qty').value = record.quantities.rd || 0;
            document.getElementById('kaa-qty').value = record.quantities.kaa || 0;
            document.getElementById('bom-qty').value = record.quantities.bom || 0;
            document.getElementById('other-qty').value = record.quantities.other || 0;

            this.setImage(record.image, 'record');
            
            this.showPage('add-record');
            this.calculateTimeAndCosts();
            this.showAlert('Editing record. Make changes and click "Save Record".', 'info');
        }
    }

    deleteRecord(id) {
        this.records = this.records.filter(record => record.id !== id);
        this.saveAllData();
        this.updateDashboard();
        this.displayRecords();
        this.showAlert('Record deleted successfully!', 'success');
    }
    
    resetForm() {
        document.getElementById('record-form').reset();
        document.getElementById('date').valueAsDate = new Date();
        this.removeImage('record');
        this.calculateTotals();
        this.editingRecordId = null;
    }
    saveFeedback() {
    const newFeedback = {
        id: Date.now(),
        name: document.getElementById('feedback-name').value,
        email: document.getElementById('feedback-email').value,
        location: document.getElementById('feedback-location').value,
        category: document.getElementById('feedback-category').value,
        subject: document.getElementById('feedback-subject').value,
        message: document.getElementById('feedback-message').value,
        rating: parseInt(document.getElementById('feedback-rating').value),
        image: this.currentFeedbackImage,
        date: new Date().toLocaleDateString('en-IN'),
        timestamp: new Date().toISOString()
    };
    
    this.feedback.push(newFeedback);
    // Don't add to readFeedback - keep it as unread notification
    this.saveAllData();
    this.updateNotificationsUI();
    this.displayFeedback();
    this.showAlert('Feedback submitted successfully!', 'success');
    this.resetFeedbackForm();
}
    
    resetFeedbackForm() {
        document.getElementById('feedback-form').reset();
        this.setRating({ target: { dataset: { rating: 0 } } });
        this.removeImage('feedback');
    }
    
    generateProjectId() {
        const id = this.projectIdCounter.toString().padStart(5, '0');
        document.getElementById('project-unique-id').value = id;
    }

    saveProject() {
    const newProject = {
        id: document.getElementById('project-unique-id').value,
        title: document.getElementById('project-title').value,
        description: document.getElementById('project-description').value,
        priority: document.getElementById('project-priority').value,
        location: document.getElementById('project-location').value,
        dueDate: document.getElementById('project-due-date').value,
        image: this.currentProjectImage,
        status: 'pending',
        createdDate: new Date().toLocaleDateString('en-IN'),
        timestamp: new Date().toISOString()
    };
    
    this.projects.push(newProject);
    this.projectIdCounter++;
    this.saveAllData();
    this.updateNotificationsUI();
    this.displayProjects();
    this.showAlert('Project added successfully!', 'success');
    this.resetProjectForm();
}
    resetProjectForm() {
        document.getElementById('project-form').reset();
        document.getElementById('project-due-date').valueAsDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
        this.removeImage('project');
        this.generateProjectId();
    }
    updateDashboard() {
        const totalSavings = this.records.reduce((sum, record) => sum + (record.totalSavings || 0), 0);
        const totalTime = this.records.reduce((sum, record) => sum + (record.printingTimeHrs || 0), 0);
        
        const roiValue = Math.abs(totalSavings - this.investment);
        
        document.getElementById('roi-value').textContent = `₹${roiValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('savings-value').textContent = `₹${totalSavings.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('time-value').textContent = `${totalTime.toFixed(2)} hrs`;
        document.getElementById('records-value').textContent = this.records.length;
        document.getElementById('investment-amount').value = this.investment;

        this.updateCharts();
    }
    
    updateCharts() {
        const createOrUpdateChart = (chartInstance, elementId, config) => {
            if (chartInstance) chartInstance.destroy();
            const ctx = document.getElementById(elementId).getContext('2d');
            return new Chart(ctx, config);
        };

        const totalSavings = this.records.reduce((sum, record) => sum + (record.totalSavings || 0), 0);
        this.roiChart = createOrUpdateChart(this.roiChart, 'roi-chart', {
            type: 'doughnut',
            data: {
                labels: ['Savings Achieved', 'Investment Yet to Recover'],
                datasets: [{
                    data: [totalSavings, Math.max(0, this.investment - totalSavings)],
                    backgroundColor: ['#48bb78', '#667eea'], borderWidth: 0
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

        const monthlyData = this.getMonthlyData();
        
        this.savingsChart = createOrUpdateChart(this.savingsChart, 'savings-chart', {
            type: 'line',
            data: { labels: monthlyData.labels, datasets: [{
                label: 'Cumulative Savings', data: monthlyData.savings,
                borderColor: '#48bb78', backgroundColor: 'rgba(72, 187, 120, 0.1)', fill: true }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { callback: v => `₹${v.toLocaleString()}` } } } }
        });
        
        const materialData = this.getMaterialUsage();
        this.materialChart = createOrUpdateChart(this.materialChart, 'material-chart', {
            type: 'bar',
            data: { labels: materialData.labels, datasets: [{
                    label: 'Usage Count', data: materialData.data,
                    backgroundColor: ['#667eea', '#764ba2', '#48bb78', '#f56565', '#ed8936', '#38b2ac']
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
        });

        this.recordsChart = createOrUpdateChart(this.recordsChart, 'records-chart', {
            type: 'bar',
            data: { labels: monthlyData.labels, datasets: [{
                label: 'Records Per Month', data: monthlyData.records, backgroundColor: '#667eea' }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
        });
        
        this.hoursChart = createOrUpdateChart(this.hoursChart, 'hours-chart', {
            type: 'line',
            data: { labels: monthlyData.labels, datasets: [{
                label: 'Monthly Printing Hours', data: monthlyData.hours,
                borderColor: '#764ba2', backgroundColor: 'rgba(118, 75, 162, 0.1)', fill: true }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }
    
    getMonthlyData() {
        const monthlyStats = {};
        this.records.forEach(record => {
            const monthKey = record.date.substring(0, 7);
            if (!monthlyStats[monthKey]) {
                monthlyStats[monthKey] = { records: 0, savings: 0, hours: 0 };
            }
            monthlyStats[monthKey].records++;
            monthlyStats[monthKey].savings += record.totalSavings || 0;
            monthlyStats[monthKey].hours += record.printingTimeHrs || 0;
        });

        const sortedKeys = Object.keys(monthlyStats).sort();
        let cumulativeSavings = 0;
        return {
            labels: sortedKeys.map(key => new Date(key + '-02').toLocaleDateString('en-IN', { month: 'short', year: 'numeric' })),
            records: sortedKeys.map(key => monthlyStats[key].records),
            savings: sortedKeys.map(key => { cumulativeSavings += monthlyStats[key].savings; return cumulativeSavings; }),
            hours: sortedKeys.map(key => monthlyStats[key].hours)
        };
    }

    getMaterialUsage() {
        const materials = this.records.reduce((acc, record) => {
            acc[record.materialUsed] = (acc[record.materialUsed] || 0) + 1;
            return acc;
        }, {});
        return {
            labels: Object.keys(materials),
            data: Object.values(materials)
        };
    }
    displayRecords() {
        const tbody = document.getElementById('records-tbody');
        tbody.innerHTML = '';
        const sorted = [...this.records].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        sorted.forEach(record => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${new Date(record.date).toLocaleDateString('en-IN')}</td>
                <td>${record.projectName}</td>
                <td>${record.partName}</td>
                <td>${record.materialUsed}</td>
                <td>${record.totalQuantity}</td>
                <td>₹${(record.totalSavings || 0).toLocaleString('en-IN')}</td>
                <td>
                    ${record.image ? `<img src="${record.image}" class="image-thumbnail" onclick="event.stopPropagation(); app.showImageModal('${record.image}')" alt="Product">` : 'None'}
                </td>
                <td class="action-buttons">
                    <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); app.requestAuth('editRecord', ${record.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); app.requestAuth('deleteRecord', ${record.id})"><i class="fas fa-trash"></i></button>
                </td>
            `;
            row.style.cursor = 'pointer';
            row.onclick = () => this.showRecordDetails(record);
        });
    }
    showRecordDetails(record) {
        document.getElementById('record-detail-title').textContent = "Record Details";
        document.getElementById('record-detail-content').innerHTML = `
            <div class="detail-grid">
                <div><strong>Date:</strong> ${new Date(record.date).toLocaleDateString('en-IN')}</div>
                <div><strong>Project:</strong> ${record.projectName}</div>
                <div><strong>Part Name:</strong> ${record.partName}</div>
                <div><strong>Type:</strong> ${record.partType}</div>
                <div><strong>Size:</strong> ${record.partSize}</div>
                <div><strong>Application:</strong> ${record.application}</div>
                <div><strong>Material:</strong> ${record.materialUsed}</div>
                <div><strong>Machine:</strong> ${record.machineName}</div>
                <div><strong>Printing Time:</strong> ${record.printingTimeHrs} hrs</div>
                <div><strong>3D Print Cost:</strong> ₹${record.printCost.toLocaleString('en-IN')}</div>
                <div><strong>OEM Cost:</strong> ₹${record.oemCost.toLocaleString('en-IN')}</div>
                <div><strong>Savings/Product:</strong> ₹${record.savingsPerProduct.toLocaleString('en-IN')}</div>
                <div><strong>Total Quantity:</strong> ${record.totalQuantity}</div>
                <div><strong>Total Savings:</strong> ₹${record.totalSavings.toLocaleString('en-IN')}</div>
            </div>
            ${record.image ? `<div style="margin-top: 20px; text-align: center;"><img src="${record.image}" style="max-width: 100%; max-height: 300px; border-radius: 8px; cursor: pointer;" onclick="app.showImageModal('${record.image}')"></div>` : ''}
        `;
        document.getElementById('record-detail-modal').classList.add('active');
    }

    displayFeedback() {
        const tbody = document.getElementById('feedback-tbody');
        tbody.innerHTML = '';
        this.feedback.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(fb => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${fb.date}</td>
                <td>${fb.name}</td>
                <td>${fb.subject}</td>
                <td>${fb.category}</td>
                <td>${'<i class="fas fa-star" style="color:#ffd700;"></i>'.repeat(fb.rating) + '<i class="fas fa-star" style="color:#e2e8f0;"></i>'.repeat(5-fb.rating)}</td>
                <td>${fb.location}</td>
                <td class="action-buttons">
                    <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); app.viewFeedback(${fb.id})"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); app.requestAuth('deleteFeedback', ${fb.id})"><i class="fas fa-trash"></i></button>
                </td>`;
        });
    }
    viewFeedback(id) {
        const fb = this.feedback.find(f => f.id === id);
        if (fb) {
            document.getElementById('record-detail-title').textContent = "Feedback Details";
            document.getElementById('record-detail-content').innerHTML = `
                <div class="detail-grid">
                    <div><strong>Date:</strong> ${fb.date}</div>
                    <div><strong>From:</strong> ${fb.name} (${fb.email})</div>
                    <div><strong>Location:</strong> ${fb.location}</div>
                    <div><strong>Category:</strong> ${fb.category}</div>
                    <div style="grid-column: 1 / -1;"><strong>Subject:</strong> ${fb.subject}</div>
                    <div style="grid-column: 1 / -1; white-space: pre-wrap;"><strong>Message:</strong> ${fb.message}</div>
                    <div><strong>Rating:</strong> ${'<i class="fas fa-star" style="color:#ffd700;"></i>'.repeat(fb.rating) + '<i class="fas fa-star" style="color:#e2e8f0;"></i>'.repeat(5-fb.rating)}</div>
                </div>
                ${fb.image ? `<div style="margin-top: 20px; text-align: center;"><img src="${fb.image}" style="max-width: 100%; max-height: 300px; border-radius: 8px; cursor: pointer;" onclick="app.showImageModal('${fb.image}')"></div>` : ''}
            `;
            document.getElementById('record-detail-modal').classList.add('active');
        }
    }

    displayProjects() {
        const tbody = document.getElementById('projects-tbody');
        tbody.innerHTML = '';
        this.projects.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(p => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${p.id}</td>
                <td>${p.title}</td>
                <td><span class="status-badge status-${p.priority}">${p.priority}</span></td>
                <td>${new Date(p.dueDate).toLocaleDateString('en-IN')}</td>
                <td><span class="status-badge status-${p.status}">${p.status}</span></td>
                <td class="action-buttons">
                    <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); app.viewProject('${p.id}')"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); app.requestAuth('deleteProject', '${p.id}')"><i class="fas fa-trash"></i></button>
                </td>`;
        });
    }
    viewProject(id) {
        const p = this.projects.find(proj => proj.id === id);
        if (p) {
            document.getElementById('record-detail-title').textContent = "Project Details";
            document.getElementById('record-detail-content').innerHTML = `
                <div class="detail-grid">
                    <div><strong>Project ID:</strong> ${p.id}</div>
                    <div><strong>Title:</strong> ${p.title}</div>
                    <div><strong>Status:</strong> <span class="status-badge status-${p.status}">${p.status}</span></div>
                    <div><strong>Priority:</strong> <span class="status-badge status-${p.priority}">${p.priority}</span></div>
                    <div><strong>Location:</strong> ${p.location}</div>
                    <div><strong>Due Date:</strong> ${new Date(p.dueDate).toLocaleDateString('en-IN')}</div>
                    <div style="grid-column: 1 / -1; white-space: pre-wrap;"><strong>Description:</strong> ${p.description}</div>
                </div>
                ${p.image ? `<div style="margin-top: 20px; text-align: center;"><img src="${p.image}" style="max-width: 100%; max-height: 300px; border-radius: 8px; cursor: pointer;" onclick="app.showImageModal('${p.image}')"></div>` : ''}
            `;
            document.getElementById('record-detail-modal').classList.add('active');
        }
    }
    
    searchRecords() {
        const searchTerm = document.getElementById('record-search').value.toLowerCase();
        document.querySelectorAll('#records-tbody tr').forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
        });
    }

    clearSearch(type) {
        if (type === 'record') {
            document.getElementById('record-search').value = '';
            this.searchRecords();
        }
    }
    handleImageUpload(event, type) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => this.setImage(e.target.result, type);
            reader.readAsDataURL(file);
        }
    }

    setImage(imageData, type) {
        const previewId = { record: 'image-preview', feedback: 'feedback-image-preview', project: 'project-image-preview' }[type];
        const imageProp = { record: 'currentRecordImage', feedback: 'currentFeedbackImage', project: 'currentProjectImage' }[type];
        
        this[imageProp] = imageData;
        document.getElementById(previewId).innerHTML = `<img src="${imageData}" alt="Preview" onclick="app.showImageModal('${imageData}')">`;
    }

    removeImage(type = 'record') {
        const previewId = { record: 'image-preview', feedback: 'feedback-image-preview', project: 'project-image-preview' }[type];
        const imageProp = { record: 'currentRecordImage', feedback: 'currentFeedbackImage', project: 'currentProjectImage' }[type];
        
        this[imageProp] = null;
        document.getElementById(previewId).innerHTML = '<div class="empty-state">No image selected</div>';
    }

    removeFeedbackImage() { this.removeImage('feedback'); }
    removeProjectImage() { this.removeImage('project'); }

    async startCamera(type = 'record') {
        if (this.currentStream) this.stopCamera();
        this.cameraType = type;
        try {
            this.currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('camera-video').srcObject = this.currentStream;
            document.getElementById('camera-container').style.display = 'flex';
        } catch (error) {
            console.error("Camera Error:", error);
            this.showAlert('Camera access denied or unavailable.', 'error');
        }
    }
    startFeedbackCamera() { this.startCamera('feedback'); }
    startProjectCamera() { this.startCamera('project'); }
    capturePhoto() {
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('camera-canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        this.setImage(canvas.toDataURL('image/jpeg', 0.9), this.cameraType);
        this.stopCamera();
    }
    stopCamera() {
        if (this.currentStream) {
            this.currentStream.getTracks().forEach(track => track.stop());
        }
        this.currentStream = null;
        document.getElementById('camera-container').style.display = 'none';
    }
    setRating(event) {
        const rating = parseInt(event.target.dataset.rating) || 0;
        document.getElementById('feedback-rating').value = rating;
        document.querySelectorAll('.star').forEach((star, i) => {
            star.classList.toggle('active', i < rating);
        });
    }

    hoverRating(event) {
        const rating = parseInt(event.target.dataset.rating);
        document.querySelectorAll('.star').forEach((star, i) => {
            star.style.color = (i < rating) ? '#ffd700' : '#e2e8f0';
        });
    }

    resetHover() {
        const rating = parseInt(document.getElementById('feedback-rating').value);
        this.hoverRating({ target: { dataset: { rating } } });
    }
    requestAuth(action, id = null) {
        this.authAction = action;
        this.authId = id;
        document.getElementById('auth-password').value = '';
        document.getElementById('auth-modal').classList.add('active');
        document.getElementById('auth-password').focus();
    }

    verifyAuth() {
        if (document.getElementById('auth-password').value === this.authPassword) {
            this.executeAuthAction();
            this.closeModal('auth-modal');
        } else {
            this.showAlert('Incorrect password!', 'error');
        }
    }
        executeAuthAction() {
        const actions = {
            updateInvestment: () => this.updateInvestment(),
            clearAllRecords: () => { this.records = []; this.saveAllData(); this.updateDashboard(); this.displayRecords(); this.showAlert('All records cleared.', 'success'); },
            clearAllFeedback: () => { this.feedback = []; this.saveAllData(); this.updateNotificationsUI(); this.displayFeedback(); this.showAlert('All feedback cleared.', 'success'); },
            editRecord: () => this.editRecord(this.authId),
            deleteRecord: () => this.deleteRecord(this.authId),
            deleteFeedback: () => { this.feedback = this.feedback.filter(fb => fb.id !== this.authId); this.saveAllData(); this.updateNotificationsUI(); this.displayFeedback(); this.showAlert('Feedback deleted.', 'success'); },
            deleteProject: () => { this.projects = this.projects.filter(p => p.id !== this.authId); this.saveAllData(); this.updateNotificationsUI(); this.displayProjects(); this.showAlert('Project deleted.', 'success'); },
            markProjectCompleted: () => this.markProjectCompleted(),
        };
        if(actions[this.authAction]) actions[this.authAction]();
    }
        updateInvestment() {
        const newInvestment = parseFloat(document.getElementById('investment-amount').value);
        if (!isNaN(newInvestment) && newInvestment >= 0) {
            this.investment = newInvestment;
            this.saveAllData();
            this.updateDashboard();
            this.showAlert('Investment amount updated!', 'success');
        } else {
            this.showAlert('Invalid investment amount.', 'error');
        }
    }
    markProjectCompleted() {
        const projectId = document.getElementById('completed-project-id').value.trim();
        const project = this.projects.find(p => p.id === projectId);
        if (project) {
            project.status = 'completed';
            this.saveAllData();
            this.updateNotificationsUI();
            this.displayProjects();
            document.getElementById('completed-project-id').value = '';
            this.showAlert(`Project ${projectId} marked as completed!`, 'success');
        } else {
            this.showAlert('Project ID not found!', 'error');
        }
    }
    
    closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }
    
    showImageModal(imageSrc) {
        document.getElementById('modal-image').src = imageSrc;
        document.getElementById('image-modal').classList.add('active');
    }
    updateNotificationsUI() {
    const unreadFeedback = this.feedback.filter(fb => !this.readFeedback.includes(fb.id)).length;
    const unreadProjects = this.projects.filter(p => p.status === 'pending' && !this.readProjects.includes(p.id)).length;
    
    const feedbackCountEl = document.getElementById('feedback-count');
    const projectCountEl = document.getElementById('project-count');

    feedbackCountEl.textContent = unreadFeedback;
    projectCountEl.textContent = unreadProjects;
    
    feedbackCountEl.style.display = unreadFeedback > 0 ? 'flex' : 'none';
    projectCountEl.style.display = unreadProjects > 0 ? 'flex' : 'none';
}

    closeNotificationDropdowns() {
        document.getElementById('feedback-dropdown').style.display = 'none';
        document.getElementById('project-dropdown').style.display = 'none';
    }
   toggleNotifications(type) {
    const dropdown = document.getElementById(`${type}-dropdown`);
    const isCurrentlyOpen = dropdown.style.display === 'block';

    this.closeNotificationDropdowns();

    if (!isCurrentlyOpen) {
        dropdown.style.display = 'block';
        if (type === 'feedback') {
            this.populateFeedbackNotifications();
            // Mark all feedback as read when opened
            this.feedback.forEach(fb => {
                if (!this.readFeedback.includes(fb.id)) {
                    this.readFeedback.push(fb.id);
                }
            });
        } else if (type === 'projects') {
            this.populateProjectNotifications();
            // Mark all pending projects as read when opened
            this.projects.filter(p => p.status === 'pending').forEach(p => {
                if (!this.readProjects.includes(p.id)) {
                    this.readProjects.push(p.id);
                }
            });
        }
        this.saveAllData();
        this.updateNotificationsUI();
    }
}
    populateFeedbackNotifications() {
    const content = document.getElementById('feedback-notifications');
    const recent = this.feedback.slice(-5).reverse();
    content.innerHTML = recent.length === 0 ? '<p style="padding: 10px; color: #718096;">No new feedback</p>' : 
        recent.map(fb => `
            <div class="notification-item" onclick="app.viewFeedback(${fb.id}); app.showPage('feedback-history'); app.closeNotificationDropdowns();">
                <div class="notification-title">${fb.subject}</div>
                <div class="notification-body">from ${fb.name}</div>
            </div>`).join('');
}

populateProjectNotifications() {
    const content = document.getElementById('project-notifications');
    const pendingProjects = this.projects.filter(p => p.status === 'pending').slice(-5).reverse();
    content.innerHTML = pendingProjects.length === 0 ? '<p style="padding: 10px; color: #718096;">No pending projects</p>' : 
        pendingProjects.map(p => `
            <div class="notification-item" onclick="app.viewProject('${p.id}'); app.showPage('needed-projects'); app.closeNotificationDropdowns();">
                <div class="notification-title">${p.title}</div>
                <div class="notification-body">Due: ${new Date(p.dueDate).toLocaleDateString('en-IN')} | Priority: ${p.priority}</div>
            </div>`).join('');
}
 
    showAlert(message, type = 'info', duration = 1000) {
        const alertContainer = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertContainer.appendChild(alert);
        
        void alert.offsetWidth;
        alert.classList.add('show');
        
        setTimeout(() => {
            alert.classList.remove('show');
            alert.addEventListener('transitionend', () => alert.remove());
        }, duration);
    }
async exportToExcel() {
    this.showAlert('Preparing Excel export...', 'info');

    try {
        if (typeof ExcelJS === 'undefined') {
            this.showAlert('Loading ExcelJS library...', 'info');
            await this.loadScript('https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js');
        }
        
        if (typeof saveAs === 'undefined') {
            this.showAlert('Loading FileSaver library...', 'info');
            await this.loadScript('https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js');
        }
        this.showAlert('Creating Excel file with embedded images...', 'info');

        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Records');

        worksheet.columns = [
            { header: 'Date', key: 'date', width: 12 },
            { header: 'Project Name', key: 'projectName', width: 25 },
            { header: 'Part Name', key: 'partName', width: 20 },
            { header: 'Part Type', key: 'partType', width: 15 },
            { header: 'Part Size', key: 'partSize', width: 15 },
            { header: 'Application', key: 'application', width: 25 },
            { header: 'Material Used', key: 'materialUsed', width: 18 },
            { header: 'Machine Name', key: 'machineName', width: 18 },
            { header: 'Printing Time (hrs)', key: 'printingTimeHrs', width: 15 },
            { header: 'Total 3D Print Cost (₹)', key: 'printCost', width: 18, style: { numFmt: '"₹"#,##0.00' } },
            { header: 'OEM Cost (₹)', key: 'oemCost', width: 15, style: { numFmt: '"₹"#,##0.00' } },
            { header: 'Savings per Product (₹)', key: 'savingsPerProduct', width: 20, style: { numFmt: '"₹"#,##0.00' } },
            { header: 'BNG Qty', key: 'bngQty', width: 10 },
            { header: 'Sampling Qty', key: 'samplingQty', width: 12 },
            { header: 'R&D Qty', key: 'rdQty', width: 10 },
            { header: 'Andhra Qty', key: 'kaaQty', width: 12 },
            { header: 'RCC Qty', key: 'rccQty', width: 10 },
            { header: 'Samudra Qty', key: 'bomQty', width: 12 },
            { header: 'Other Units Qty', key: 'otherQty', width: 12 },
            { header: 'Total Quantity', key: 'totalQuantity', width: 12 },
            { header: 'Total Savings (₹)', key: 'totalSavings', width: 18, style: { numFmt: '"₹"#,##0.00' } },
            { header: 'SharePoint Link', key: 'sharepointLink', width: 35 },
            { header: 'Product Image', key: 'image', width: 22 }
        ];
        
        worksheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
        worksheet.getRow(1).fill = { type: 'pattern', pattern:'solid', fgColor:{argb:'FF4F81BD'} };
        worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };

        const imageColNumber = worksheet.getColumn('image').number;

        for (const record of this.records) {
            const rowData = {
                date: new Date(record.date).toLocaleDateString('en-IN'),
                projectName: record.projectName,
                partName: record.partName,
                partType: record.partType,
                partSize: record.partSize,
                application: record.application,
                materialUsed: record.materialUsed,
                machineName: record.machineName,
                printingTimeHrs: record.printingTimeHrs,
                printCost: record.printCost,
                oemCost: record.oemCost,
                savingsPerProduct: record.savingsPerProduct,
                bngQty: record.quantities?.bng || 0,
                samplingQty: record.quantities?.sampling || 0,
                rdQty: record.quantities?.rd || 0,
                kaaQty: record.quantities?.kaa || 0,
                rccQty: record.quantities?.rcc || 0,
                bomQty: record.quantities?.bom || 0,
                otherQty: record.quantities?.other || 0,
                totalQuantity: record.totalQuantity,
                totalSavings: record.totalSavings,
                sharepointLink: record.sharepointLink ? { text: 'Open Link', hyperlink: record.sharepointLink } : 'N/A',
                image: ''
            };

            const row = worksheet.addRow(rowData);
            
            if (record.image) {
                try {
                    const base64Image = record.image;
                    const imageId = workbook.addImage({
                        base64: base64Image,
                        extension: 'png',
                    });
                    
                    worksheet.addImage(imageId, {
                        tl: { col: imageColNumber - 1, row: row.number - 1 },
                        ext: { width: 150, height: 100 }
                    });
                    
                    row.height = 80;

                } catch (e) {
                    console.error(`Failed to process image for record ${record.id}:`, e);
                    row.getCell('image').value = 'Error processing image';
                }
            } else {
                row.getCell('image').value = 'No Image Provided';
            }
            
            row.alignment = { vertical: 'middle' };
        }
        const summaryWs = workbook.addWorksheet('Summary');
        const totalSavings = this.records.reduce((sum, r) => sum + (r.totalSavings || 0), 0);
        const locationTotals = this.records.reduce((totals, record) => {
            if (record.quantities) {
                totals.bng += record.quantities.bng || 0;
                totals.sampling += record.quantities.sampling || 0;
                totals.rd += record.quantities.rd || 0;
                totals.kaa += record.quantities.kaa || 0;
                totals.rcc += record.quantities.rcc || 0;
                totals.bom += record.quantities.bom || 0;
                totals.other += record.quantities.other || 0;
            }
            return totals;
        }, { bng: 0, sampling: 0, rd: 0, kaa: 0, rcc: 0, bom: 0, other: 0 });

        const summaryData = [
            ['FINANCIAL SUMMARY', ''],
            ['Total Investment', this.investment],
            ['Total Savings To-Date', totalSavings],
            ['Net ROI', totalSavings - this.investment],
            ['', ''],
            ['PRODUCTION SUMMARY', ''],
            ['Total Printing Time (hours)', this.records.reduce((sum, r) => sum + (r.printingTimeHrs || 0), 0).toFixed(2)],
            ['Total Records Created', this.records.length],
            ['Records with Images', this.records.filter(r => r.image).length],
            ['', ''],
            ['LOCATION-WISE QUANTITIES', ''],
            ['BNG Total Quantity', locationTotals.bng],
            ['Sampling Total Quantity', locationTotals.sampling],
            ['R&D Total Quantity', locationTotals.rd],
            ['Andhra Total Quantity', locationTotals.kaa],
            ['RCC Total Quantity', locationTotals.rcc],
            ['Samudra Total Quantity', locationTotals.bom],
            ['Other Units Total Quantity', locationTotals.other],
            ['Grand Total Quantity', Object.values(locationTotals).reduce((sum, qty) => sum + qty, 0)],
            ['', ''],
            ['Export Date', new Date().toLocaleString('en-IN')]
        ];
        
        summaryWs.addRows(summaryData);
        summaryWs.columns = [{ width: 30 }, { width: 25 }];
        
        summaryWs.eachRow((row, rowNumber) => {
            row.getCell(1).font = { bold: true };
            if ([2, 3, 4].includes(rowNumber)) {
                row.getCell(2).numFmt = '"₹"#,##0.00';
            }
            if ([1, 6, 11].includes(rowNumber)) {
                row.fill = { type: 'pattern', pattern:'solid', fgColor:{argb:'FFE6E6FA'} };
                row.getCell(1).font = { bold: true, size: 12 };
            }
        });
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const fileName = `3D_Analytics_Export_${new Date().toISOString().slice(0,10)}.xlsx`;
        saveAs(blob, fileName);
        this.showAlert('Excel file with embedded images and location quantities created successfully!', 'success');

    } catch (error) {
        console.error('Error during Excel export:', error);
        this.showAlert('Failed to create Excel file. Please try again.', 'error');
    }
}
loadScript(src) {
    return new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) {
            resolve();
            return;
        }

        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
        document.head.appendChild(script);
    });
}

    toggleSidebar() {
        document.querySelector('.sidebar').classList.toggle('open');
    }

    populateManagementData() {}
}


const app = new PrintingAnalyticsApp();
document.addEventListener('click', (e) => {
    if (!e.target.closest('.notification-bell')) {
        document.querySelectorAll('.notification-dropdown').forEach(d => d.style.display = 'none');
    }
    if (!e.target.closest('.sidebar') && !e.target.closest('.mobile-menu-btn')) {
        document.querySelector('.sidebar').classList.remove('open');
    }
});

document.getElementById('auth-password').addEventListener('keyup', function(event) {
    if (event.key === "Enter") {
        event.preventDefault();
        app.verifyAuth();
    }
});
</script>
</body>
</html>